
import jsPDF from 'jspdf';

export interface BusinessPlanData {
  cooperationMode: string;
  title: string;
  description: string;
  features: Array<{ title: string; desc: string }>;
  financialModel: string[];
}

export const generateBusinessPlanPDF = (data: BusinessPlanData) => {
  const pdf = new jsPDF();
  let yPosition = 20;
  const pageWidth = pdf.internal.pageSize.width;
  const margin = 20;
  const maxWidth = pageWidth - 2 * margin;

  // 添加设计感的背景和装饰
  const addDesignElements = () => {
    // 顶部渐变色带
    pdf.setFillColor(79, 172, 254);
    pdf.rect(0, 0, pageWidth, 8, 'F');
    pdf.setFillColor(14, 165, 233);
    pdf.rect(0, 8, pageWidth, 4, 'F');
    
    // 底部装饰线
    pdf.setDrawColor(79, 172, 254);
    pdf.setLineWidth(1);
    pdf.line(margin, 285, pageWidth - margin, 285);
  };

  // 设置中文字体（使用内置字体）
  pdf.setFont('helvetica');
  
  // 添加首页设计元素
  addDesignElements();

  // 主标题
  pdf.setFontSize(20);
  pdf.setTextColor(0, 0, 0);
  pdf.text('Glocal智能供应链合作商业计划书', pageWidth / 2, yPosition, { align: 'center' });
  yPosition += 15;

  // 副标题装饰
  pdf.setFontSize(12);
  pdf.setTextColor(79, 172, 254);
  pdf.text('构建智能化供应链生态，共创数字化未来', pageWidth / 2, yPosition, { align: 'center' });
  yPosition += 25;

  // 合作模式标题
  pdf.setFontSize(16);
  pdf.setTextColor(0, 100, 200);
  const modeTitle = getModeTitle(data.cooperationMode.slice(-1));
  pdf.text(modeTitle, margin, yPosition);
  yPosition += 20;

  // 获取对应模式的具体内容
  const modeContent = getModeSpecificContent(data.cooperationMode.slice(-1));
  
  // 渲染模式内容
  modeContent.forEach(section => {
    if (yPosition > 250) {
      pdf.addPage();
      addDesignElements();
      yPosition = 25;
    }

    // 章节标题
    pdf.setFontSize(14);
    pdf.setTextColor(0, 100, 200);
    pdf.text(section.title, margin, yPosition);
    yPosition += 12;

    // 章节内容
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);
    section.content.forEach(paragraph => {
      const lines = pdf.splitTextToSize(paragraph, maxWidth);
      pdf.text(lines, margin, yPosition);
      yPosition += lines.length * 5 + 5;
      
      if (yPosition > 250) {
        pdf.addPage();
        addDesignElements();
        yPosition = 25;
      }
    });
    
    yPosition += 10;
  });

  // 新页面 - 合作协议
  pdf.addPage();
  addDesignElements();
  yPosition = 25;

  // 合同标题
  pdf.setFontSize(18);
  pdf.setTextColor(0, 0, 0);
  pdf.text('供应链合作协议', pageWidth / 2, yPosition, { align: 'center' });
  yPosition += 25;

  // 合同内容
  const contractContent = getContractContent(data.cooperationMode.slice(-1));
  
  pdf.setFontSize(10);
  contractContent.forEach(line => {
    if (yPosition > 270) {
      pdf.addPage();
      addDesignElements();
      yPosition = 25;
    }
    
    if (line.startsWith('第') && line.includes('条')) {
      pdf.setFontSize(12);
      pdf.setTextColor(0, 100, 200);
      yPosition += 5;
    } else if (line.includes('甲方') && line.includes('签字')) {
      pdf.setFontSize(11);
      pdf.setTextColor(0, 0, 0);
      yPosition += 10;
    } else {
      pdf.setFontSize(10);
      pdf.setTextColor(0, 0, 0);
    }
    
    const textLines = pdf.splitTextToSize(line, maxWidth);
    pdf.text(textLines, margin, yPosition);
    yPosition += textLines.length * 5 + 3;
  });

  // 保存PDF
  const fileName = `Glocal供应链合作方案_模式${data.cooperationMode.slice(-1)}_${new Date().toISOString().split('T')[0]}.pdf`;
  pdf.save(fileName);
};

// 获取模式标题
const getModeTitle = (mode: string) => {
  const titles = {
    'A': '模式A：技术赋能型供应商（生产端技术化改造）',
    'B': '模式B："Glocal"品牌联盟（贴牌/OEM合作）',
    'C': '模式C：末端渠道优化（合作门店）',
    'D': '模式D：共生式景区合作'
  };
  return titles[mode] || '';
};

// 获取特定模式的详细内容
const getModeSpecificContent = (mode: string) => {
  const contentMap = {
    'A': [
      {
        title: '核心概念',
        content: [
          '此模式主要面向具有发展潜力但在技术和管理上相对落后的本地生产者（如农场、小型食品加工作坊）。Glocal为其提供一整套技术解决方案，以提升其生产效率、品控水平和物流能力，作为交换，Glocal获得其独家或优先的供应商资格。'
        ]
      },
      {
        title: '"技术赋能"组合包',
        content: [
          '这并非简单的专利许可，而是一个综合性的服务包，其价值远超单一专利。它包括：',
          '● 专有软件系统接入：供应商获得Glocal自研的供应链管理（SCM）软件的使用权限，实现订单、库存、生产计划的数字化管理。',
          '● AI数据决策支持：基于Glocal平台C端用户的行为数据、搜索偏好和预订趋势，AI模型为供应商提供精准的需求预测，指导其生产和备货，减少供需错配。',
          '● 标准化运营流程（SOPs）：Glocal提供一整套关于产品质量控制、食品安全规范（对于预制菜至关重要）、包装标准和物流交接的SOPs，帮助供应商达到平台要求。'
        ]
      },
      {
        title: '财务模型',
        content: [
          '● 技术改造启动金：针对技术化改造（如在大棚中安装环境传感器、部署软件系统等）收取的一次性费用。',
          '● 技术服务年费/抽成：针对SCM软件使用和AI数据分析服务，收取持续的月度/年度服务费，或按通过平台完成的交易额的一定比例收取。',
          '● 成本回收机制：为降低中小供应商的准入门槛，上述"技术改造启动金"可以由Glocal先行垫付或提供融资方案，然后在后续的交易中，按照合同约定，从货款中分期扣除。这极大地减轻了供应商的初期资金压力。',
          '● 合作保证金：供应商需缴纳一定数额的保证金，以确保其履行合同承诺，并作为潜在违约或质量问题的风险抵押。'
        ]
      }
    ],
    'B': [
      {
        title: '核心概念',
        content: [
          '此模式面向已经具备稳定生产能力和高质量产品的本地供应商。Glocal授权其生产带有"Glocal"商标的产品（即贴牌生产），使其能够借助Glocal的品牌信誉、营销渠道和用户信任，快速进入市场。'
        ]
      },
      {
        title: '法律与运营框架',
        content: [
          '● 商标授权：Glocal必须拥有"Glocal"的注册商标。OEM合作协议的核心是授予供应商在特定产品上使用该商标的有限许可。',
          '● 质量控制：这是此模式下风险最高、也最关键的一环。一旦贴牌产品出现问题（尤其是食品安全问题），Glocal作为品牌方将承担首要的法律责任和品牌声誉损失。因此，合作协议必须明确授予Glocal对生产过程的审核权和随时抽检权，详细规定产品必须达到的质量标准（可作为合同附件），并包含严格的违约责任和赔偿条款。',
          '● 价值交换：作为满足Glocal严苛质量标准的回报，供应商将获得平台提供的专项流量扶持、在商城设立"Glocal精选"专区进行重点推广，并享受平台服务费的减免（20%-50%减免是一个非常有吸引力的激励措施）。'
        ]
      }
    ],
    'C': [
      {
        title: '核心概念',
        content: [
          '此模式旨在签约本地的零售店、餐厅、酒店礼品店、特产店等作为Glocal的线下合作伙伴。核心价值在于，利用Glocal整合的、质量可控的、独特的供应链，替换掉这些门店现有的、可能质量参差不齐、来源分散的本地特产供应。'
        ]
      },
      {
        title: '双向价值主张',
        content: [
          '● 对合作门店：能够获得独家的、质量有保证的特色产品，从而在激烈的市场竞争中形成差异化；从单一、可靠的渠道（Glocal）进货，极大地简化了采购流程和管理成本。',
          '● 对Glocal：获得了一个深入社区的、低成本的线下实体分销和品牌展示网络。同时，能够实现线上线下联动，例如，酒店住客可以通过扫描房间内的二维码，直接下单购买Glocal的特色礼品盒，并由酒店前台交付。'
        ]
      },
      {
        title: '财务模型',
        content: [
          '此模式更适合采用批发模式。Glocal以批发价向合作门店供货，门店再以零售价出售，赚取差价。"不针对每个订单收取商家服务费"并"部分减免保证金"的激励方案，非常适合用于快速拓展线下合作网络。'
        ]
      }
    ],
    'D': [
      {
        title: '核心概念',
        content: [
          '与景区的合作必须超越简单的门票佣金模式，转向更深度的、共生的合作关系。'
        ]
      },
      {
        title: '模式D1（优选合作伙伴）',
        content: [
          '景区在其自营的礼品店、游客中心等显要位置，优先陈列和销售Glocal品牌或Glocal供应链提供的特色商品。作为回报，Glocal在其平台上为景区提供流量倾斜和联合营销活动，并可提供门票销售佣金的折扣（减免60%是一个很好的谈判起点）。'
        ]
      },
      {
        title: '模式D2（战略共创伙伴）',
        content: [
          '法律风险警示与战略重构：原计划中"独家销售平台商品，免予收取平台服务费"的模式，存在极高的反垄断法律风险。这种排他性要求可能被监管机构认定为《反垄断法》所禁止的"限定交易"（俗称"二选一"）行为，尤其当Glocal在某一区域或渠道形成优势地位时，此举可能构成滥用市场支配地位，面临巨额罚款和声誉打击。',
          '合规的战略转向：必须将此模式从反竞争的"排他性"重构为促进竞争的"创新性"。建议的模式是"联名体验共创"。Glocal与景区合作，共同开发一款独一无二的旅游产品或体验。例如，"Glocal x 蓬莱阁：沉浸式八仙文化夜游"，这个包含了特殊路线、AR互动、专属文创纪念品的套餐，只能通过Glocal平台或景区官方渠道购买。这种模式创造了新的市场供给，是受法律鼓励的创新，而非限制市场竞争的行为，这能向评委展示团队对商业法律环境的深刻理解和成熟思考。'
        ]
      }
    ]
  };

  return contentMap[mode] || [];
};

// 获取合同内容
const getContractContent = (mode: string) => {
  const contractTemplates = {
    'A': [
      '甲方（技术服务方）：Glocal智能供应链平台',
      '法定代表人：',
      '统一社会信用代码：',
      '地址：',
      '',
      '乙方（供应商）：',
      '法定代表人/身份证号：',
      '统一社会信用代码：',
      '地址：',
      '',
      '鉴于：',
      '1. 甲方合法拥有并运营"Glocal"线上平台（下称"平台"），并拥有一系列旨在提升农产品/食品生产与供应链管理效率的技术解决方案（下称"赋能技术"）。',
      '2. 乙方为【产品类型，如：预制菜、本地农产品】的生产者，希望通过采用甲方的赋能技术提升其生产管理水平，并成为平台的供应商。',
      '',
      '经双方友好协商，达成协议如下：',
      '',
      '第一条 定义',
      '1.1 赋能技术：指甲方提供给乙方使用的一整套技术与服务，具体包括：甲方SCM软件系统账号、AI需求预测数据报告、产品质量控制标准操作程序（SOPs）等，详见本协议附件一《技术赋能方案》。',
      '1.2 供应产品：指乙方利用赋能技术生产并供应给甲方的产品，具体规格、质量标准、定价详见本协议附件二《产品清单与定价》。',
      '',
      '第二条 技术赋能与服务',
      '2.1 甲方同意向乙方提供本协议第一条定义的赋能技术。涉及软件系统的，甲方授予乙方在本协议有效期内不可转让的、非独占的使用许可。',
      '2.2 技术改造：若涉及硬件安装或系统部署，双方同意按照附件一《技术赋能方案》执行。技术改造所产生的一次性费用（下称"技术改造启动金"）为人民币【】元，其支付方式按第4.2条执行。',
      '2.3 培训与支持：甲方应为乙方提供必要的技术使用培训和持续的技术支持。',
      '',
      '第三条 产品供应与采购',
      '3.1 乙方同意在本协议有效期内，成为甲方【独家/优先】的【产品类型】供应商。',
      '3.2 订单：甲方通过其SCM系统向乙方下达采购订单，订单中应明确产品名称、数量、交货日期和地点。',
      '3.3 质量保证：乙方保证其供应产品完全符合附件二中规定的质量标准以及所有适用的国家食品安全标准。甲方有权随时对乙方的生产场所进行检查或对产品进行抽检。',
      '',
      '第四条 费用与结算',
      '4.1 技术服务费：乙方同意向甲方支付技术服务费，计费方式为（二选一）：',
      '（A）按月/季/年支付固定服务费人民币【】元。',
      '（B）按甲方每笔采购订单总金额的【3.5%】支付。',
      '4.2 技术改造启动金支付：乙方同意以下列方式支付技术改造启动金（二选一）：',
      '（A）本协议签署后【】日内一次性支付。',
      '（B）由甲方从支付给乙方的货款中分期扣除，每笔货款扣除【】%或固定金额【】元，直至全部扣清为止。',
      '4.3 货款结算：甲方在收到乙方供应产品并验收合格后【】个工作日内，向乙方支付货款。支付时将扣除当期应付的技术服务费及/或技术改造启动金分期款项。',
      '4.4 保证金：乙方须在本协议签署后【】日内，向甲方缴纳合作保证金人民币【】元。该保证金用于担保乙方履行本协议项下义务。协议终止且乙方无任何违约行为时，甲方应在【】日内无息退还。'
    ],
    'B': [
      '甲方（品牌授权方/平台方）：Glocal智能供应链平台',
      '乙方（生产商/被授权方）：',
      '',
      '第一条 合作内容',
      '1.1 乙方申请作为生产商入驻甲方运营的"Glocal"平台，并通过贴牌生产（OEM）模式，生产带有甲方"Glocal"注册商标（注册号：【】）的特定产品（下称"OEM产品"），并在甲方平台上销售。',
      '1.2 OEM产品清单、规格、质量标准、包装要求详见本协议附件一。',
      '',
      '第二条 商标授权',
      '2.1 甲方授予乙方一项非独占的、不可转让的、不可再许可的商标使用许可，允许乙方仅为生产本协议约定的OEM产品之目的，在产品本身及其包装上使用"Glocal"商标。',
      '2.2 乙方不得在任何超出本协议约定范围的场合使用甲方商标。本协议终止后，乙方应立即停止使用甲方商标。',
      '',
      '第三条 质量控制与食品安全',
      '3.1 核心条款：乙方保证其生产的所有OEM产品，在任何时候均完全符合附件一规定的质量标准，以及《中华人民共和国食品安全法》等所有相关法律法规的强制性要求。',
      '3.2 甲方审核权：甲方有权在不提前通知的情况下，随时进入乙方的生产、仓储场所，对生产流程、卫生条件、原材料、半成品及成品进行检查和审核。乙方必须予以配合。',
      '3.3 产品抽检：甲方有权随时对OEM产品进行抽样检测，检测费用由甲方承担。若检测不合格，复检费用及由此产生的一切损失由乙方承担。',
      '3.4 产品召回：若OEM产品被证实存在安全隐患或不符合法律规定，乙方必须立即启动召回程序，并承担所有相关费用。'
    ],
    'C': [
      '甲方（供应商）：Glocal智能供应链平台',
      '乙方（合作门店）：',
      '',
      '第一条 合作内容',
      '1.1 甲方同意向乙方供应其整合或自有的"Glocal"系列特色产品（下称"合作产品"），产品清单详见附件。',
      '1.2 乙方同意在其经营场所（地址：【】）内销售合作产品。',
      '',
      '第二条 供货与订货',
      '2.1 订货：乙方通过甲方指定的线上订货系统或联系客户经理进行订货。',
      '2.2 价格：甲方按附件中的"批发价"向乙方供货。',
      '2.3 配送：甲方负责将乙方订购的货物配送至乙方指定经营场所，运费由【甲方/乙方】承担。',
      '2.4 验收：乙方在收到货物时应立即验收，如有数量不符或包装破损，应在【24小时】内通知甲方。',
      '',
      '第三条 结算方式',
      '3.1 双方采取【月结/批结】方式结算。',
      '3.2 月结：甲方于次月【】日前向乙方提供上月对账单，乙方核对无误后在【】日内向甲方支付全部货款。',
      '3.3 批结：乙方在每次订货时/货到时支付该批次货款。'
    ],
    'D': [
      '甲方（合作方）：Glocal智能供应链平台',
      '乙方（景区）：',
      '',
      '第一条 合作模式（二选一）',
      '模式A：优选合作伙伴',
      '1.1 乙方同意在其景区内的自营商店（具体位置：【】）中，优先和重点陈列、销售由甲方供应的"Glocal"系列文创产品和特色食品（下称"合作产品"）。',
      '1.2 作为回报，甲方同意：',
      '(a) 在其运营的"Glocal"平台上，为乙方提供【例如：首页推荐位、专题文章推广】等联合营销支持。',
      '(b) 若乙方通过甲方平台销售电子门票，甲方收取的平台服务费（佣金）在标准费率【10%】的基础上，给予【60%】的减免，即按实际交易额的【4%】收取。',
      '',
      '模式B：战略共创伙伴',
      '1.1 双方同意共同策划、开发并运营一款联名旅游体验产品，暂定名为【例如："Glocal x 景区名称：主题体验之旅"】（下称"联名产品"）。',
      '1.2 联名产品内容：具体包括【例如：特殊游览路线、专属导览服务、定制文创纪念品、特色餐饮体验等】，详见附件《联名产品开发方案》。',
      '1.3 收入分成：联名产品对外销售所产生的净收入（指总收入扣除约定成本后），由甲乙双方按照【甲方XX%：乙方XX%】的比例进行分配。',
      '1.4 独家性：联名产品为双方共同知识产权，仅可通过甲方平台和乙方官方渠道进行销售，任何一方不得单独授权第三方销售。'
    ]
  };

  const baseContract = [
    '',
    '第四条 保密义务',
    '双方对合作中获知的商业秘密承担保密义务。',
    '',
    '第五条 违约责任',
    '任何一方违约应承担相应法律责任和赔偿义务。',
    '',
    '第六条 争议解决',
    '因本协议产生的争议，双方应友好协商解决；协商不成的，提交有管辖权的人民法院裁决。',
    '',
    '第七条 其他条款',
    '本协议有效期为三年，可续签。未尽事宜另行协商。',
    '',
    '',
    '甲方签字：_________________    日期：_________________',
    '',
    '乙方签字：_________________    日期：_________________',
    '',
    '（本协议一式两份，甲乙双方各执一份）'
  ];

  return [...(contractTemplates[mode] || []), ...baseContract];
};
